#!/bin/bash

yum upgrade -y

adduser ansible
home=/home/ansible

aws_updatekey_command="aws s3 cp --quiet s3://${s3_bucket}/${ssh_key}.pub $home/.ssh/authorized_keys"
cat > /etc/sudoers.d/00-ansible <<EOF
ansible ALL=(ALL) NOPASSWD: ALL
EOF

echo "*/5 * * * * ansible $aws_updatekey_command" >> /etc/cron.d/update_ssh_pubkey

mkdir -p $home/.ssh/
while ! $($aws_updatekey_command); do
	sleep 1
done


chmod 600 $home/.ssh/authorized_keys
chown -R ansible:ansible $home/.ssh

